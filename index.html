<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Line Follower Advanced Simulator</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/loader.min.js"></script>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 1400px;">
            <div>
                <h1>Simulador de Seguidor de Lineas</h1>
                <nav class="tabs">
                    <button class="tab-button active" data-tab="simulation">Simulación</button>
                    <button class="tab-button" data-tab="code-editor">Editor de Código</button>
                    <button class="tab-button" data-tab="robot-editor">Editor de Robot</button>
                    <button class="tab-button" data-tab="track-editor">Editor de Pista</button>
                </nav>
            </div>
            <img src="assets/Logo%20guaroduino.png" alt="Logo Guaroduino" class="header-logo">
        </div>
    </header>

    <main>
        <!-- Simulation Tab -->
        <div id="simulation" class="tab-content active">
            <div class="simulation-layout simulation-double-column">
                <div class="simulation-view">
                    <canvas id="simulationDisplayCanvas" width="700" height="500"></canvas>
                    <div class="simulation-controls">
                        <button id="startSimButton">Iniciar</button>
                        <button id="stopSimButton" disabled>Detener</button>
                        <button id="resetSimButton">Reiniciar Sim</button>
                        <button id="placeStartLineSimButton">Ubicar Línea de Comienzo</button>
                    </div>
                </div>
                <div class="simulation-parameters">
                    <details id="simParamsDetails">
                        <summary><h3 style="display:inline; font-size:1.1em; font-weight:600; margin:0;">Parámetros de Simulación</h3></summary>
                        <label for="timeStep">Paso de Tiempo (s):</label>
                        <input type="number" id="timeStep" value="0.01" step="0.001" min="0.001">
                        <label for="maxRobotSpeed">Vel. Máx. Robot (m/s):</label>
                        <input type="number" id="maxRobotSpeed" value="1.0" step="0.05" min="0.05">
                        <label for="motorEfficiency">Eficiencia Motor (0-1):</label>
                        <input type="number" id="motorEfficiency" value="0.85" step="0.01" min="0.1" max="1">
                        <label for="motorResponse">Respuesta Motor (0-1):</label>
                        <input type="number" id="motorResponse" value="0.1" step="0.01" min="0.01" max="1">
                        <label for="sensorNoise">Ruido Sensor (0-1):</label>
                        <input type="number" id="sensorNoise" value="0.0" step="0.01" min="0" max="1">
                        <label for="movementPerturb">Perturb. Movim. (0-1):</label>
                        <input type="number" id="movementPerturb" value="0.0" step="0.01" min="0" max="1">
                        <label for="motorDeadband">PWM Banda Muerta Motor:</label>
                        <input type="number" id="motorDeadband" value="40" step="1" min="0">
                        <label for="lineThreshold">Umbral Línea (0-255):</label>
                        <input type="number" id="lineThreshold" value="100" step="1" min="0" max="255">
                        <button id="applySimParamsButton">Aplicar Parámetros</button>
                    </details>
                </div>
                <div class="sim-monitor-column">
                    <h4>Monitor Serial</h4>
                    <pre id="serialMonitorOutput"></pre>
                    <button id="clearSerialButton" type="button">Limpiar Serial</button>
                    <h4>Cronómetro</h4>
                    <pre id="lapTimerOutput">Vueltas: 0 | Mejor: --:--:--- | Actual: --:--:---</pre>
                </div>
            </div>
        </div>

        <!-- Code Editor Tab -->
        <div id="code-editor" class="tab-content">
            <div class="code-editor-layout">
                <div class="code-editor-container">
                    <div class="code-template-selector">
                        <label for="codeTemplate">Seleccionar tipo de control:</label>
                        <select id="codeTemplate" class="template-select">
                            <option value="custom">Código Personalizado</option>
                            <option value="onoff" selected>Control On/Off Simple</option>
                            <option value="continuous-turn">Control On/Off con Giro Continuo</option>
                            <option value="proportional">Control Proporcional</option>
                            <option value="pid">Control PID Completo</option>
                        </select>
                    </div>
                    <div id="monacoContainer" style="height: 600px; border: 1px solid #ccc;"></div>
                    <div class="editor-help">
                        <h2>Editor de Código (Arduino-like JavaScript)</h2>
                        <h3>¿Cómo usar este editor?</h3>
                        <p>¡Aquí puedes escribir el código que controla tu robot! Cambia el tipo de control arriba, edita el código y mira cómo responde el robot en la simulación. Si te equivocas, no pasa nada, puedes volver a intentarlo.</p>
                        <h4>Funciones que puedes usar:</h4>
                        <ul>
                            <li><strong>setup()</strong>: Se ejecuta una vez al comenzar. Aquí preparas todo.</li>
                            <li><strong>loop()</strong>: Se repite muchas veces. Aquí va la lógica principal.</li>
                            <li><strong>digitalRead(pin)</strong>: Lee si un sensor está sobre la línea (0) o fuera (1).</li>
                            <li><strong>analogWrite(pin, valor)</strong>: Cambia la velocidad de los motores (0 a 255).</li>
                            <li><strong>(...)</strong> y <strong>Serial.println(...)</strong>: Muestra mensajes en el Monitor Serial.</li>
                            <li><strong>delay(ms)</strong>: Espera el tiempo que le digas (en milisegundos).</li>
                        </ul>
                        <p>¡Diviértete probando y aprendiendo cómo hacer que tu robot siga la línea!</p>
                    </div>
                </div>
                <div class="serial-and-explanation">
                    <div class="code-explanation">
                        <h3>Guía del Código</h3>
                        <p>Este editor te permite modificar el comportamiento del robot seguidor de línea. El código simula un programa de Arduino y contiene dos funciones principales:</p>
                        <h4>Funciones Principales:</h4>
                        <ul>
                            <li><strong>setup()</strong>: Se ejecuta una vez al inicio. Configura los pines y la comunicación serial.</li>
                            <li><strong>loop()</strong>: Se ejecuta continuamente. Lee los sensores y controla los motores.</li>
                        </ul>
                        <h4>Pines y Variables Importantes:</h4>
                        <ul>
                            <li><strong>Sensores (digitalRead)</strong>: LEFT_SENSOR_PIN(2), CENTER_SENSOR_PIN(3), RIGHT_SENSOR_PIN(4)</li>
                            <li><strong>Motores (analogWrite)</strong>: MOTOR_LEFT_PWM(6), MOTOR_RIGHT_PWM(5)</li>
                            <li>Los sensores retornan 0 cuando están sobre la línea negra y 1 cuando están fuera</li>
                            <li>Los motores aceptan valores entre 0 (parado) y 255 (máxima velocidad)</li>
                        </ul>
                        <h4>Tipos de Control Disponibles:</h4>
                        <ul>
                            <li><strong>On/Off</strong>: Control básico que solo gira a la izquierda o derecha según el sensor activado.</li>
                            <li><strong>Proporcional</strong>: Ajusta la velocidad de giro según qué tan lejos está de la línea.</li>
                            <li><strong>PID</strong>: Control avanzado que considera el error actual (P), acumulado (I) y su variación (D).</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Robot Editor Tab -->
        <div id="robot-editor" class="tab-content">
            <div class="robot-editor-layout">
                <div class="robot-preview">
                    <h3>Vista Previa del Robot</h3>
                    <canvas id="robotPreviewCanvas" width="300" height="300"></canvas>
                    <div class="robot-parts-palette">
                        <h4>Partes Decorativas</h4>
                        <div id="robotPartsPalette">
                            <!-- Parts will be loaded here by JS -->
                        </div>
                    </div>
                </div>
                <div class="robot-parameters">
                    <h3>Geometría del Robot (en metros)</h3>
                    <label for="robotWidth">
                        Ancho (dist. ruedas) (m):
                        <input type="number" id="robotWidth" value="0.10" step="0.01" min="0.02">
                    </label>
                    
                    <label for="sensorOffset">
                        Offset Sensores Delante (m):
                        <input type="number" id="sensorOffset" value="0.05" step="0.005" min="0">
                    </label>
                    
                    <label for="sensorSpread">
                        Separación Sensores Laterales (m):
                        <input type="number" id="sensorSpread" value="0.03" step="0.005" min="0">
                    </label>
                    
                    <label for="sensorDiameter">
                        Diámetro Sensor (m):
                        <input type="number" id="sensorDiameter" value="0.005" step="0.001" min="0.001">
                    </label>
                    
                    <button id="applyRobotGeometryButton">Aplicar Geometría y Reiniciar Sim</button>
                    <button id="resetRobotGeometryButton">Geometría por Defecto</button>
                    <div style="margin-top: 1em; display: flex; gap: 0.5em; align-items: center;">
                        <button id="saveRobotButton" class="file-input-label" style="flex:1;">Guardar Robot</button>
                        <label for="loadRobotInput" class="file-input-label" style="flex:1;">Cargar Robot (.json)</label>
                        <input type="file" id="loadRobotInput" accept=".json" style="display:none;">
                    </div>
                    <div style="margin-top: 1em;">
                        <label for="robotSelectionDropdown">Seleccionar Robot Predefinido:</label>
                        <select id="robotSelectionDropdown" style="width: 100%; margin-top: 0.5em;">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Track Editor Tab -->
        <div id="track-editor" class="tab-content">
            <div class="track-editor-layout">
                <div class="track-editor-grid">
                    <canvas id="trackEditorCanvas"></canvas> <!-- Size set by JS -->
                </div>
                <div class="track-editor-controls">
                    <h3>Controles de Pista</h3>
                    <label for="trackGridSize">Tamaño Grid:</label>
                    <select id="trackGridSize">
                        <option value="3x3">3x3</option>
                        <option value="4x4" selected>4x4</option>
                        <option value="5x5">5x5</option>
                    </select>
                    <button id="generateRandomTrack">Generar Pista Aleatoria (Loop)</button>
                    <button id="exportTrackToSimulator">Usar en Simulación</button>
                    <button id="clearTrackButton" class="danger" style="margin-top:0.5em;">Limpiar Pista</button>
                    <hr>
                    <label for="trackEditorTrackName">Nombre de Pista:</label>
                    <input type="text" id="trackEditorTrackName" value="MiPistaEditada">
                    <button id="saveTrackDesignButton">Guardar Diseño</button>
                    <label for="loadTrackDesignInput" class="file-input-label">Cargar Diseño (.json)</label>
                    <input type="file" id="loadTrackDesignInput" accept=".json,.trackdesign" style="display:none;">
                    <hr>
                </div>
                <div class="track-parts-palette-container">
                    <h3>Paleta de Piezas</h3>
                    <div id="trackPartsPalette">
                        <!-- Piezas se cargarán aquí por JS -->
                    </div>
                    <p class="small-text">Click para Ubicar, Doble-Click para rotar.</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>Simulador Avanzado de Seguidor de Línea - 2025. Ing. Luis Fernando Corado</p>
    </footer>

    <script type="module" src="js/main.js"></script>
</body>
</html>