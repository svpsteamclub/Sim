<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Line Follower Advanced Simulator</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/loader.min.js"></script>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 1400px;">
            <div>
                <h1>Simulador de Seguidor de Lineas</h1>
                <nav class="tabs">
                    <button class="tab-button active" data-tab="introduccion">Introducción</button>
                    <button class="tab-button" data-tab="simulation">Simulación</button>
                    <button class="tab-button" data-tab="code-editor">Editor de Código</button>
                    <button class="tab-button" data-tab="robot-editor">Editor de Robot</button>
                    <button class="tab-button" data-tab="track-editor">Editor de Pista</button>
                </nav>
            </div>
            <img src="assets/Logo%20guaroduino.png" alt="Logo Guaroduino" class="header-logo">
        </div>
    </header>

    <main>
        <!-- Introducción Tab -->
        <div id="introduccion" class="tab-content active">
            <div style="max-width:700px;margin:2em auto 0 auto;text-align:left;">
                <h2>Introducción</h2>
                <h1>🤖 Explorando el Mundo de los Robots Seguidores de Líneas y Nuestro Simulador</h1>
                <p>¡Bienvenido a la sección de aprendizaje de nuestro simulador de robots seguidores de líneas! Aquí descubrirás qué son estos fascinantes robots, cómo funcionan, cómo se programan con Arduino y, lo más importante, cómo puedes usar nuestro simulador para diseñar, probar y optimizar tus propios robots virtuales.</p>
                <hr>
                <h2>¿Qué es un Robot Seguidor de Líneas?</h2>
                <p>Un <strong>robot seguidor de líneas</strong> es un vehículo autónomo diseñado para detectar y seguir una línea dibujada en el suelo. Esta línea suele ser de un color que contrasta fuertemente con la superficie (por ejemplo, una línea negra sobre un fondo blanco, o viceversa). Estos robots son muy populares en el ámbito educativo y en competencias de robótica, ya que introducen conceptos fundamentales de sensado, lógica de control y actuación.</p>
                <p>Su funcionamiento se basa en un bucle constante de:</p>
                <ol>
                    <li><strong>Sensar:</strong> Detectar la posición de la línea con respecto al robot.</li>
                    <li><strong>Decidir:</strong> Aplicar una lógica de control para determinar cómo debe moverse el robot.</li>
                    <li><strong>Actuar:</strong> Mover los motores para corregir la trayectoria y mantenerse sobre la línea.</li>
                </ol>
                <hr>
                <h2>Componentes Típicos de un Robot Seguidor de Líneas Físico</h2>
                <p>Aunque nuestro simulador es virtual, es útil conocer los componentes de un robot real para entender mejor su funcionamiento:</p>
                <ul>
                    <li><strong>Chasis:</strong> Es la estructura física del robot que sostiene todos los demás componentes. Su diseño (material, forma, tamaño) puede influir en el rendimiento.</li>
                    <li><strong>Microcontrolador (Arduino):</strong> Actúa como el "cerebro" del robot. Una placa Arduino (como Arduino UNO) es comúnmente utilizada debido a su facilidad de programación y versatilidad. Recibe información de los sensores y envía comandos a los motores.</li>
                    <li><strong>Sensores Infrarrojos (IR):</strong> Son los "ojos" del robot. Típicamente se usan pares de emisor-detector infrarrojo (como el CNY70 o módulos TCRT5000). El emisor envía luz IR y el detector mide cuánta luz se refleja. Una superficie blanca refleja más luz IR que una negra. Con varios sensores, el robot puede saber si está centrado, a la izquierda o a la derecha de la línea.</li>
                    <li><strong>Motores y Ruedas:</strong> Proporcionan el movimiento. Generalmente se usan dos motores de corriente continua (DC) con ruedas, permitiendo giros diferenciales (una rueda gira más rápido que la otra, o en sentido contrario, para cambiar de dirección).</li>
                    <li><strong>Controlador de Motores (Puente H):</strong> Un microcontrolador como Arduino no puede suministrar directamente la corriente que necesitan los motores. Un controlador de motores (por ejemplo, el L293D o L298N) actúa como un intermediario, permitiendo al Arduino controlar la velocidad y dirección de los motores.</li>
                    <li><strong>Fuente de Alimentación:</strong> Baterías o un paquete de pilas que proporcionan la energía necesaria para todos los componentes electrónicos.</li>
                    <li><strong>Rueda Loca o Deslizador:</strong> Un tercer punto de apoyo (además de las dos ruedas motrices) que permite al robot girar con facilidad.</li>
                </ul>
                <hr>
                <h2>Programación con Arduino IDE</h2>
                <p>Los robots seguidores de líneas basados en Arduino se programan utilizando el <strong>Arduino IDE (Entorno de Desarrollo Integrado)</strong>. El lenguaje de programación es una variante de C/C++.</p>
                <p>La lógica básica de control en el código de Arduino suele seguir estos pasos dentro de la función <code>loop()</code> (que se ejecuta continuamente):</p>
                <ol>
                    <li><strong>Leer los Sensores:</strong> Obtener los valores digitales (NEGRO/BLANCO) o analógicos (niveles de reflexión) de los sensores de línea.</li>
                    <li><strong>Tomar Decisiones:</strong> Basándose en las lecturas de los sensores, determinar la posición del robot respecto a la línea:
                        <ul>
                            <li>Si el sensor izquierdo detecta la línea negra y el derecho blanco: el robot está desviado a la derecha, necesita girar a la izquierda.</li>
                            <li>Si el sensor derecho detecta la línea negra y el izquierdo blanco: el robot está desviado a la izquierda, necesita girar a la derecha.</li>
                            <li>Si ambos sensores (o el central, si se usan más) detectan la línea: el robot está centrado, debe avanzar.</li>
                            <li>Si ningún sensor detecta la línea: el robot se ha salido (o es una sección sin línea), puede detenerse o implementar una rutina de búsqueda.</li>
                        </ul>
                    </li>
                    <li><strong>Controlar los Motores:</strong> Enviar las señales adecuadas al controlador de motores para que las ruedas giren a la velocidad y dirección deseadas para ejecutar la corrección.</li>
                </ol>
                <p>En el editor de código del simulador podrás usar un lenguaje parecido al usado en Arduino, pero simplificado.</p>
            </div>
        </div>

        <!-- Simulation Tab -->
        <div id="simulation" class="tab-content">
            <div class="simulation-layout simulation-double-column">
                <div class="simulation-view">
                    <canvas id="simulationDisplayCanvas" width="700" height="500"></canvas>
                    <div class="simulation-controls">
                        <button id="startSimButton">Iniciar</button>
                        <button id="stopSimButton" disabled>Detener</button>
                        <button id="resetSimButton">Reiniciar Sim</button>
                        <button id="placeStartLineSimButton">Ubicar Línea de Comienzo</button>
                    </div>
                </div>
                <div class="simulation-parameters">
                    <details id="simParamsDetails">
                        <summary><h3 style="display:inline; font-size:1.1em; font-weight:600; margin:0;">Parámetros de Simulación</h3></summary>
                        <label for="timeStep">Paso de Tiempo (s):</label>
                        <input type="number" id="timeStep" value="0.01" step="0.001" min="0.001">
                        <label for="maxRobotSpeed">Vel. Máx. Robot (m/s):</label>
                        <input type="number" id="maxRobotSpeed" value="1.0" step="0.05" min="0.05">
                        <label for="motorEfficiency">Eficiencia Motor (0-1):</label>
                        <input type="number" id="motorEfficiency" value="0.85" step="0.01" min="0.1" max="1">
                        <label for="motorResponse">Respuesta Motor (0-1):</label>
                        <input type="number" id="motorResponse" value="0.1" step="0.01" min="0.01" max="1">
                        <label for="sensorNoise">Ruido Sensor (0-1):</label>
                        <input type="number" id="sensorNoise" value="0.0" step="0.01" min="0" max="1">
                        <label for="movementPerturb">Perturb. Movim. (0-1):</label>
                        <input type="number" id="movementPerturb" value="0.0" step="0.01" min="0" max="1">
                        <label for="motorDeadband">PWM Banda Muerta Motor:</label>
                        <input type="number" id="motorDeadband" value="40" step="1" min="0">
                        <label for="lineThreshold">Umbral Línea (0-255):</label>
                        <input type="number" id="lineThreshold" value="100" step="1" min="0" max="255">
                        <button id="applySimParamsButton">Aplicar Parámetros</button>
                    </details>
                </div>
                <div class="sim-monitor-column">
                    <h4>Monitor Serial</h4>
                    <pre id="serialMonitorOutput"></pre>
                    <button id="clearSerialButton" type="button">Limpiar Serial</button>
                    <h4>Cronómetro</h4>
                    <pre id="lapTimerOutput">Vueltas: 0 | Mejor: --:--:--- | Actual: --:--:---</pre>
                </div>
            </div>
        </div>

        <!-- Code Editor Tab -->
        <div id="code-editor" class="tab-content">
            <div class="code-editor-layout">
                <div class="code-editor-container">
                    <div class="code-template-selector">
                        <label for="codeTemplate">Seleccionar tipo de control:</label>
                        <select id="codeTemplate" class="template-select">
                            <option value="custom">Código Personalizado</option>
                            <option value="onoff" selected>Control On/Off Simple</option>
                            <option value="continuous-turn">Control On/Off con Giro Continuo</option>
                            <option value="proportional">Control Proporcional</option>
                            <option value="pid">Control PID Completo</option>
                        </select>
                    </div>
                    <div id="monacoContainer" style="height: 600px; border: 1px solid #ccc;"></div>
                    <div class="editor-help">
                        <h2>Editor de Código (Arduino-like JavaScript)</h2>
                        <h3>¿Cómo usar este editor?</h3>
                        <p>¡Aquí puedes escribir el código que controla tu robot! Cambia el tipo de control arriba, edita el código y mira cómo responde el robot en la simulación. Si te equivocas, no pasa nada, puedes volver a intentarlo.</p>
                        <h4>Funciones que puedes usar:</h4>
                        <ul>
                            <li><strong>setup()</strong>: Se ejecuta una vez al comenzar. Aquí preparas todo.</li>
                            <li><strong>loop()</strong>: Se repite muchas veces. Aquí va la lógica principal.</li>
                            <li><strong>digitalRead(pin)</strong>: Lee si un sensor está sobre la línea (0) o fuera (1).</li>
                            <li><strong>analogWrite(pin, valor)</strong>: Cambia la velocidad de los motores (0 a 255).</li>
                            <li><strong>(...)</strong> y <strong>Serial.println(...)</strong>: Muestra mensajes en el Monitor Serial.</li>
                            <li><strong>delay(ms)</strong>: Espera el tiempo que le digas (en milisegundos).</li>
                        </ul>
                        <p>¡Diviértete probando y aprendiendo cómo hacer que tu robot siga la línea!</p>
                    </div>
                </div>
                <div class="serial-and-explanation">
                    <div class="code-explanation">
                        <h3>Guía del Código</h3>
                        <p>Este editor te permite modificar el comportamiento del robot seguidor de línea. El código simula un programa de Arduino y contiene dos funciones principales:</p>
                        <h4>Funciones Principales:</h4>
                        <ul>
                            <li><strong>setup()</strong>: Se ejecuta una vez al inicio. Configura los pines y la comunicación serial.</li>
                            <li><strong>loop()</strong>: Se ejecuta continuamente. Lee los sensores y controla los motores.</li>
                        </ul>
                        <h4>Pines y Variables Importantes:</h4>
                        <ul>
                            <li><strong>Sensores (digitalRead)</strong>: LEFT_SENSOR_PIN(2), CENTER_SENSOR_PIN(3), RIGHT_SENSOR_PIN(4)</li>
                            <li><strong>Motores (analogWrite)</strong>: MOTOR_LEFT_PWM(6), MOTOR_RIGHT_PWM(5)</li>
                            <li>Los sensores retornan 0 cuando están sobre la línea negra y 1 cuando están fuera</li>
                            <li>Los motores aceptan valores entre 0 (parado) y 255 (máxima velocidad)</li>
                        </ul>
                        <h4>Tipos de Control Disponibles:</h4>
                        <ul>
                            <li><strong>On/Off</strong>: Control básico que solo gira a la izquierda o derecha según el sensor activado.</li>
                            <li><strong>Proporcional</strong>: Ajusta la velocidad de giro según qué tan lejos está de la línea.</li>
                            <li><strong>PID</strong>: Control avanzado que considera el error actual (P), acumulado (I) y su variación (D).</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Robot Editor Tab -->
        <div id="robot-editor" class="tab-content">
            <div class="robot-editor-layout">
                <div class="robot-preview">
                    <h3>Vista Previa del Robot</h3>
                    <canvas id="robotPreviewCanvas" width="300" height="300"></canvas>
                    <div class="robot-parts-palette">
                        <h4>Partes Decorativas</h4>
                        <div id="robotPartsPalette">
                            <!-- Parts will be loaded here by JS -->
                        </div>
                    </div>
                    <div class="robot-editor-help" style="margin-top:1em; font-size:0.95em; color:#234e70; background:#f8f9fa; border-radius:8px; padding:0.8em 1em;">
                        <strong>¿Cómo usar el editor de robot?</strong><br>
                        <ul style="margin:0.5em 0 0 1.2em; padding:0;">
                            <li>Haz <b>click</b> en una pieza y luego <b>arrástrala</b> al robot para ubicarla.</li>
                            <li><b>Click y arrastrar</b> sobre una pieza ya colocada para moverla.</li>
                            <li><b>Doble click</b> sobre una pieza para rotarla.</li>
                            <li>Activa <b>Modo Borrar</b> y haz <b>doble click</b> en una pieza para eliminarla.</li>
                            <li>Haz click en <b>Aplicar Geometría y Reiniciar Sim</b> para cargar el robot en el simulador.</li>
                            <li>Usa <b>Guardar Robot</b> para descargar tu diseño y <b>Cargar Robot</b> para restaurarlo.</li>
                            <li>Puedes cargar un robot prearmado desde la lista desplegable.</li>
                        </ul>
                    </div>
                </div>
                <div class="robot-parameters">
                    <h3>Geometría del Robot (en metros)</h3>
                    <label for="robotWidth">
                        Ancho (dist. ruedas) (m):
                        <input type="number" id="robotWidth" value="0.10" step="0.01" min="0.02">
                    </label>
                    
                    <label for="sensorOffset">
                        Offset Sensores Delante (m):
                        <input type="number" id="sensorOffset" value="0.05" step="0.005" min="0">
                    </label>
                    
                    <label for="sensorSpread">
                        Separación Sensores Laterales (m):
                        <input type="number" id="sensorSpread" value="0.03" step="0.005" min="0">
                    </label>
                    
                    <label for="sensorDiameter">
                        Diámetro Sensor (m):
                        <input type="number" id="sensorDiameter" value="0.005" step="0.001" min="0.001">
                    </label>
                    
                    <button id="applyRobotGeometryButton">Aplicar Geometría y Reiniciar Sim</button>
                    <button id="resetRobotGeometryButton">Geometría por Defecto</button>
                    <div style="margin-top: 1em; display: flex; gap: 0.5em; align-items: center;">
                        <button id="saveRobotButton" style="flex:1; text-align:center;">Guardar Robot</button>
                        <label for="loadRobotInput" class="file-input-label" style="flex:1; text-align:center;">Cargar Robot (.json)</label>
                        <input type="file" id="loadRobotInput" accept=".json" style="display:none;">
                    </div>
                    <div style="margin-top: 1em;">
                        <label for="robotSelectionDropdown">Seleccionar Robot Predefinido:</label>
                        <select id="robotSelectionDropdown" style="width: 100%; margin-top: 0.5em;">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Track Editor Tab -->
        <div id="track-editor" class="tab-content">
            <div class="track-editor-layout">
                <div class="track-editor-grid">
                    <canvas id="trackEditorCanvas"></canvas> <!-- Size set by JS -->
                </div>
                <div class="track-editor-controls">
                    <h3>Controles de Pista</h3>
                    <label for="trackGridSize">Tamaño Grid:</label>
                    <select id="trackGridSize">
                        <option value="3x3">3x3</option>
                        <option value="4x4" selected>4x4</option>
                        <option value="5x5">5x5</option>
                    </select>
                    <button id="generateRandomTrack">Generar Pista Aleatoria (Loop)</button>
                    <button id="exportTrackToSimulator">Usar en Simulación</button>
                    <button id="clearTrackButton" class="danger" style="margin-top:0.5em;">Limpiar Pista</button>
                    <hr>
                    <div style="display: flex; gap: 0.5em; align-items: center; margin-top: 1em;">
                        <button id="saveTrackDesignButton" style="flex:1; text-align:center;">Guardar Diseño</button>
                        <label for="loadTrackDesignInput" class="file-input-label" style="flex:1; text-align:center;">Cargar Diseño (.json)</label>
                        <input type="file" id="loadTrackDesignInput" accept=".json,.trackdesign" style="display:none;">
                    </div>
                </div>
                <div class="track-parts-palette-container">
                    <h3>Paleta de Piezas</h3>
                    <div id="trackPartsPalette">
                        <!-- Piezas se cargarán aquí por JS -->
                    </div>
                    <p class="small-text">Click para Ubicar, Doble-Click para rotar.</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>Simulador Avanzado de Seguidor de Línea - 2025. Ing. Luis Fernando Corado</p>
    </footer>

    <script type="module" src="js/main.js"></script>
</body>
</html>